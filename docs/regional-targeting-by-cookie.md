# 타겟팅 광고 수집하기: 쿠키 활용을 통한 기존 방식의 한계 극복

## 🚨 문제의 배경

람다에서 크롤링을 하게 되면 실제 크롤링 결과와 다르게 나오는 경우가 존재합니다. 이는 광고주가 지역 타겟팅을 설정해놓아서, 람다의 IP가 만약 '인천'이라면 그 외의 지역에만 노출되도록 타겟팅한 광고는 크롤링 과정에서 잡을 수 없었습니다.

위 리포트는 해당 문제를 해결하고 지속 가능한 방법을 제시합니다.

## 🔍 문제 해결 과정

### 1️⃣ 지역 타겟팅 제어 헤더 탐색

<img width="167" height="614" alt="image" src="https://github.com/user-attachments/assets/c7c0b46c-3663-4fdd-bf7a-f5314e62b8c5" />

지역 타겟팅을 컨트롤할 수 있는 헤더가 있을지 확인하였습니다. 대부분의 헤더는 브라우저 관련이고, 유일한 후보는 `Cookie` 헤더였습니다.

### 2️⃣ Cookie 헤더 분석

`Cookie` 헤더에서도 지역 타겟팅을 컨트롤할만한 후보가 2개 있었습니다.

#### 2-1. NV_WETR_LOCATION_RGN_M

```
NV_WETR_LOCATION_RGN_M="MDk2ODAxMDE="
```

해당 값을 Base64 디코딩하면 숫자가 나옵니다. (`"MDk2ODAxMDE="` → `09680101`)

<img width="186" height="310" alt="Image" src="https://github.com/user-attachments/assets/01f95883-011f-4736-b23a-954950614963" />

이 숫자값은 네이버 안에서 지역을 관리하는 코드입니다. 하지만 해당 코드값을 바꾼다고 크롤링 결과가 달라지지는 않았습니다.

#### 2-2. m_loc

```
m_loc=1c1aff76836421fc9db8042ffd8434251d954e63f2d8f39752941a3fd5f88451;
```

해당 값에 따라 크롤링 결과가 바뀌는 것을 확인했습니다. 

하지만 해시값이기 때문에 디코딩할 수 없어, 직접 계산할 수 있는 방법이 없었습니다.

### 3️⃣ m_loc 쿠키 생성 원리 분석

m_loc 쿠키가 어느 시점에서 브라우저 쿠키에 삽입되는지 체크해보았고, 다음과 같습니다.

1. 네이버를 이용하는 사용자의 **접속위치가 확인되는 시점**에 삽입
2. 사용자의 접속위치는 '네이버 날씨' 에서 제어 가능
3. 지역명 옆의 **현재 접속위치 확인 버튼**을 누른 시점에 사용자의 접속위치 확인
4. 해당 시점에 브라우저에 m_loc 쿠키가 삽입

### 4️⃣ m_loc API 발견

그렇다면 m_loc 값을 구하기 위해 그 지역에 직접 가야 할까요?

아쉽게도(?) 네트워크 통신 상에서 m_loc 값을 구할 수 있는 API 링크를 확인할 수 있었습니다.

```
https://weather.naver.com/api/naverRgnCatForCoords?lat={위도}&lng={경도}
```

해당 링크에 위도와 경도 값을 넣으면 해당 지역의 m_loc 값을 구할 수 있습니다.

**✨ 따라서 위도와 경도만 알면 지역 타겟팅을 제어할 수 있는 m_loc 쿠키 값을 구할 수 있었습니다.**

### 5️⃣ 완성된 솔루션

데모 시연을 위해 **🗺️ 주소를 입력하면 위도와 경도 값을 구해주는 카카오맵 API**를 활용하여, 주소와 키워드를 입력하면 해당 지역의 크롤링 결과를 확인할 수 있는 기능을 완성했습니다.

## 💻 구현 결과

다음 지역을 타겟팅한다고 가정합니다.

<img width="817" height="549" alt="Image" src="https://github.com/user-attachments/assets/a408c49e-0d2f-40fe-ba1f-a9bef1ceae8f" />

'치과' 키워드로 테스트한 실제 크롤링 결과입니다.

<img width="965" height="312" alt="Image" src="https://github.com/user-attachments/assets/75fa8084-04e2-4988-8d94-9fa5509c00c4" />

<img width="965" height="312" alt="Image" src="https://github.com/user-attachments/assets/d11640f1-3188-4ae5-9233-940cf52ba2db" />

<img width="965" height="312" alt="Image" src="https://github.com/user-attachments/assets/e37bdaab-23e4-4688-9dd0-399c0c4cb966" />

<img width="965" height="312" alt="Image" src="https://github.com/user-attachments/assets/cded0f3a-7ed9-4c76-854f-122a97b6b231" />

각 지역마다 서로 다른 광고 결과가 나오는 것을 확인했으며, 쿠키 값을 제어함으로써 지역 타겟팅이 정상적으로 진행되고 있음을 검증했습니다.

## 🎉 성과 및 의의

### 🔧 기술적 성과
- 🚫 **프록시 불필요**: 원래 지역 타겟팅을 하려면 거주용 IP 프록시를 구매해야 하나 고민이었는데, 프록시를 더 이상 고려하지 않아도 됩니다.
- ♻️ **지속 가능한 방법**: 네이버 내부에서 사용하는 API를 활용한 방식이므로 안정적입니다.
- 🌍 **확장 가능성**: 전국 어느 지역이든 주소만 있으면 해당 지역의 크롤링 결과 확인이 가능합니다.

### 💼 비즈니스 임팩트
- 💰 **비용 절감**: 프록시 서비스 구매 비용이 불필요합니다.
- ⚡ **운영 효율성**: 지역별 광고 모니터링이 가능합니다.
- 📈 **데이터 품질**: 실제 해당 지역 사용자가 보는 광고와 동일한 결과를 수집할 수 있습니다.
- 